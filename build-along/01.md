**10 Jan 2024**

[Create a GitHub
Codespace](https://github.com/mastodon/mastodon#github-codespaces)

This uses the information that defined in the `.devcontainer` folder within
the Mastodon repository to bring up a VM.

Building the VM takes a while. It ran into an error during post-create.sh step
somewhere, and instead created a recovery container.

Shows a web based VS Code with the mastodon source, and the error:

> This codespace is currently running in recovery mode due to a configuration
  error. Please review the creation logs, update your dev container
  configuration as needed, and run the "Rebuild Container" command to rectify.

The error seemed to be in the `rails assets:precompile` step (we can see the
full script at `.devcontainer/post-create.sh` in the VS code instance that has
opened up).

It's called precompile, let's see if the thing works without it too.

Run

```sh
$ foreman start -f Procfile.dev
foreman: command not found
```

Issue:
* Failed to setup dev env following README
  (https://github.com/mastodon/mastodon/issues/27398)
* Other similar ones...

[Docs for codespaces](https://docs.github.com/en/codespaces)

It is probably not finding foreman because we're in the recovery container.
Let's comment out the `set -e` from `post-create.sh`. VS Code helpfully asks if
we want to rebuild (thank you Clippy!). It also tells us

> Rebuilding recreates your codespace. Currently cached images will be
> preserved, together with your code and any current changes. Your codespace
> will be rebuilt using your working directory's dev container.

Still fails. The princess is in another castle. The creation log shows the
following error:

```
2024-01-10 08:25:09.904Z: Compilation failed:2024-01-10 08:25:09.908Z:
2024-01-10 08:25:09.919Z: /workspaces/mastodon/node_modules/webpack-cli/bin/cli.js:93
				throw err;
				^
TypeError: Cannot read properties of undefined (reading 'compress')
...
    at Object.<anonymous> (/workspaces/mastodon/node_modules/webpack/bin/webpack.js:156:2)

Node.js v20.10.0

2024-01-10 08:25:10.012Z: postCreateCommand failed with exit code 1. Skipping any further user-provided commands.

```

Bisecting, I can zero into the following line causing the error:

```sh
# Precompile assets for test
RAILS_ENV=test ./bin/rails assets:precompile
```

Since we're not going to test, commenting it out.

---

Continuing with the steps in the mastodon README,

```sh
foreman start -f Procfile.dev
```

VS Code helpfully tells us

> Your application running on port 3000 is available.
>
> - See all forwarded ports.
> - Open in browser
> - Make public

Mastodon README says to choose open in browser. We get a new window saying
"connecting to the forwarded port...", and nice! the new window shows the
Mastodon UI.

Finally, the last step in the README is

> On the Ports tab, right click on the “stream” row and select Port visibility →
> Public.

But for now, the browser window it opened with the preview is enough for what we
want to do (see the impact of customizing the CSS), don't need to do this.

---

Styles seem to be in `app/javascript/styles/mastodon/`. Not sure what should be
pasted into the advanced prefs (custom CSS or custom SCSS?), so let us try to
login.

The admin account seems to be `admin@localhost`, but what's the password?

Trying `bin/tootctl`

```sh
$ bin/tootctl accounts create -h
Usage:
  tootctl accounts create USERNAME --email=EMAIL

Options:
  --email=EMAIL
  [--confirmed], [--no-confirmed]
  [--role=ROLE]
  [--reattach], [--no-reattach]
  [--force]
  [--approve], [--no-approve]

Description:
  Create a new user account with a given USERNAME and an e-mail address provided
  with --email.  With the --confirmed option, the confirmation e-mail will be
  skipped and the account will be active straight away.

  With the --role option, the role can be supplied.  With the --approve option,
  the account will be approved.
```

Refs:

* Create the admin user with tootctl #15850
  https://github.com/mastodon/mastodon/issues/15850

```sh
$ bin/tootctl accounts create admin1 --email=manav@mrmr.io --confirmed --role admin --approve
Cannot find user role with that name
$ bin/tootctl accounts create admin --email admin@localhost --confirmed --role admin
Cannot find user role with that name
```

Following this (Admin CLI doesn't work out of the box for 1-click Digital Ocean
installs](https://github.com/mastodon/mastodon/discussions/18137)), I think it
should be "Admin"

```sh
$ bin/tootctl accounts create admin --email admin@localhost --confirmed --role Admin
Failure/Error: account.username
    taken
Failure/Error: account.username
    reserved
```

Hmm. Trying `admin@localhost` again. [From
here](https://github.com/spinda/mastodon-documentation/blob/master/Running-Mastodon/Development-guide.md),
we see that the password is "mastodonadmin". Searching for that in code gives
us, in `db/seeds/04_admin.rb`:

```
User.where(email: "admin@#{domain}").first_or_initialize(email: "admin@#{domain}", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true).save!
```

So it should be `admin@#{domain}`. Replace localhost with the URL of the dev
container preview (without the https).

    admin@xxx-3000.app.github.dev

Worked!

---

Under Prefs > Administration > Server settings > Appearance,

    https://xxx-3000.app.github.dev/admin/settings/appearance

we can see the custom CSS textarea

> Custom CSS
>
> You can apply custom styles on the web version of Mastodon.

What do we put here? This old (2018) but probably only relevant tutorial
([battlepenguin.com](https://battlepenguin.com/tech/using-custom-css-with-mastodon/))
gives an example (and more):

```css
.ui p, .landing-page p, .public-layout p {
  color: black !important;
}
.status__content, .reply-indicator__content {
  color: black;
}
```

Let's try a hammer first.

```css
p {
  color: red !important;
}
```

Save. Works! Bits of text are in red.

So now we need to find the selectors that we need to customize.

---

There might be better ways, but maybe the simplest is to use the browser dev
tools and inspect the elements that we want to customize.

However, that might lead to us missing some selectors that don't kick in
normally but when they do kick in (say, dropdowns), they might fight with our
overrides. So maybe it is better to start with the one of the predefined themes.

Unfortunately, `app/javascript/styles/mastodon` has a lot of SCSS code.

We can look at the CSS that the page actually loaded. One is `custom.css` (the
one we're creating). One is `inert.css`, looks fairly inert. One is
`common-xxx.css`, which seems to be only FontAwesome related. So that leaves us
with `default-xxx.chunk.css`.

The `.chunk` bit indicates that this is probably still not the full thing, and
would depend no the page I'm currently loading (the home page for the logged in
admin user), but let's start with this.

14000 lines lol.

So I'm not really sure what to do except the grind. Ask Claude, and ChatGPT,
both give a generic unhelpful answer.

Searching more,

* There is an 3 year old repository
  ([mast-range/cosmetics](https://github.com/mast-range/cosmetics/)) with some
  custom themes, but nothing minimal

* There is a [list of Mastodon CSS selectors from Dec
  2022](https://write.as/sweetmeat/mastodon-v4-css-selectors-for-mastodon-theme-developers),
  and might be a helpful reference.

* There are lots of CSS customizations of Mastodon at
  [userstyles](https://userstyles.world/search?q=mastodon), but they all seem to
  be either tweaks, or full blown mods of huge CSS files. e.g. The
  [mastodon-bird-ui CSS](https://github.com/ronilaukkarinen/mastodon-bird-ui)
  seems like a common starting point, but that's 4k lines.

---

Going through the `default-xxx.chunk.css`

Some root declarations

```css
:root {
    --dropdown-border-color: #42485a;
    --dropdown-background-color: #313543;
    --dropdown-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.25), 0 8px 10px -6px rgba(0, 0, 0, 0.25);
    --modal-background-color: #1f232b;
    --modal-border-color: #313543;
}
```

Next is font definitions. We're not customizing the font yet, so we can ignore
these for now.

Next is a CSS reset. This too we can ignore - we're more into theming the colors
currently, not adjusting the spacing.

All this is following the flow in `app/javascript/styles/application.scss`.

If we look into `/app/javascript/styles/contrast/variables.scss`, we can maybe
get a sense of what are the minimal colors we need to modify

```scss
$black: #000000;

$classic-base-color: #282c37;
$classic-primary-color: #9baec8;
$classic-secondary-color: #d9e1e8;
$classic-highlight-color: #6364ff;

$ui-base-color: $classic-base-color !default;
$ui-primary-color: $classic-primary-color !default;
$ui-secondary-color: $classic-secondary-color !default;
$ui-highlight-color: $classic-highlight-color !default;

$darker-text-color: lighten($ui-primary-color, 20%) !default;
$dark-text-color: lighten($ui-primary-color, 12%) !default;
$secondary-text-color: lighten($ui-secondary-color, 6%) !default;
$highlight-text-color: lighten($ui-highlight-color, 10%) !default;
$action-button-color: lighten($ui-base-color, 50%);

$inverted-text-color: $black !default;
$lighter-text-color: darken($ui-base-color, 6%) !default;
$light-text-color: darken($ui-primary-color, 40%) !default;
```

There are ways to do color manipulation in CSS itself:

- A relative color syntax, but has ~76% caniuse.
- Using `color-mix`, has ~86% caniuse. We can lighten / darken by mixing with
  black.
- We can individually control the lightness component using `calc`, should be
  much more widely supported, but it'll require us to convert each colors to
  three HSL or OKLCH components variables first.

Refs:

- [caniuse/color-mix](https://caniuse.com/?search=color-mix)

Here is an example color mix, taken from this [SO
answer](https://stackoverflow.com/questions/55329996/how-to-create-color-shades-using-css-variables-similar-to-darken-of-sass/55330103#55330103)
to "How to create color shades using CSS variables similar to darken() of Sass?"

```css
html {
  --color: #8A9B0F; /* the main color */
  --color-light: color-mix(in srgb,var(--color),#fff 25%);
  --color-dark:  color-mix(in srgb,var(--color),#000 25%);
}
```

So take these four base colors from the SCSS

```scss
$classic-base-color: #282c37;
$classic-primary-color: #9baec8;
$classic-secondary-color: #d9e1e8;
$classic-highlight-color: #6364ff;
```

And declare CSS variables for them. Give them distinct identifiable base colors
for debugging ([here's a CSS color list](https://mrmr.io/css-colors)).

```css
--mast-classic-base-color: azure;
--mast-classic-primary-color: green;
--mast-classic-secondary-color: red;
--mast-classic-highlight-color: blue;
```

Then in the `default-xxx.chunk.css` (leaving off off the font and CSS reset bits
that we pruned above), replace "#282c37" (`$classic-base-color`) with azure.
Copy paste the resulting CSS into the Custom CSS box. Save and reload. Hmm,
didn't work. Let's try `azure important!`. Worked!

So let us further prune the `default-xxx.chunk.css` until we're only left with
lines related to colors. We can use some VS Code foo to delete all lines that
match certain patterns, e.g. `^.*gap:.*` (replacing them with an empty string).
Then remove all blank lines (Regex search "^\s*$\n", replace with blank). We can
prune this way, but it's still a lot of CSS.

---

Let's see if ChatGPT can help with it. I give it the following message:

> I will give you a CSS file. Filter it to keep only CSS elements that are
> related to colors. e.g. given the following CSS
> ```
> .react-toggle--checked .react-toggle-track {
>     border-radius: 10px;
>     background-color: #6364ff;
> }
>
> .react-toggle-track-check, .react-toggle-track-x {
>     display: none;
> }
> ```
>
> the output should be
>
> ```
> .react-toggle--checked .react-toggle-track {
>     background-color: #6364ff;
> }
> ```
>
> Answer YES if you understand the task. I will then provide you the entire CSS
> file in my next message.

It answered `YES`. I pasted a 450 line file in my next message, and it seems to
have filtered it down to the colors.

So I then kept giving it the following message:

> Thank you. So that the instructions don't move out of your context window, I
> will repeat the instructions.
>
> I will give you a CSS file. Filter it to keep only CSS elements that are
> related to colors. e.g. given the following CSS:
>
> ```
> .react-toggle-`-checked .react-toggle-track {
>     border-radius: 10px;
>     background-color: #6364ff;
> }
>
> .react-toggle-track-check, .react-toggle-track-x {
>     display: none;
> }
> ```
>
> the output should be:
>
> ```
> .react-toggle--checked .react-toggle-track {
>     background-color: #6364ff;
> }
> ```
>
> Answer YES if you understand the task. I will then provide you the CSS to
> filter in my next message.
>

I tried giving it 2000 lines next, but OpenAI said that my message is too long.
So I repeated it with shorter < 1000 line snippets again and again. It started
hallucinating at times, and very likely the filtered result is not accurate, but
it's a start.

Sometimes, particularly with large chains of selectors (e.g.
".error-modal__footer"), it got confused and got in a loop. So I had to prune
such CSS rules out before I fed them to it. OpenAI would also surface a
"generate more" button, which just seemed to cause it to hallicinate out made up
CSS classes and selectors.
