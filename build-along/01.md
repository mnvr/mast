**10 Jan 2024**

[Create a GitHub
Codespace](https://github.com/mastodon/mastodon#github-codespaces)

This uses the information that defined in the `.devcontainer` folder within
the Mastodon repository to bring up a VM.

Building the VM takes a while. It ran into an error during post-create.sh step
somewhere, and instead created a recovery container.

Shows a web based VS Code with the mastodon source, and the error:

> This codespace is currently running in recovery mode due to a configuration
  error. Please review the creation logs, update your dev container
  configuration as needed, and run the "Rebuild Container" command to rectify.

The error seemed to be in the `rails assets:precompile` step (we can see the
full script at `.devcontainer/post-create.sh` in the VS code instance that has
opened up).

It's called precompile, let's see if the thing works without it too.

Run

```sh
$ foreman start -f Procfile.dev
foreman: command not found
```

Issue:
* Failed to setup dev env following README
  (https://github.com/mastodon/mastodon/issues/27398)
* Other similar ones...

[Docs for codespaces](https://docs.github.com/en/codespaces)

It is probably not finding foreman because we're in the recovery container.
Let's comment out the `set -e` from `post-create.sh`. VS Code helpfully asks if
we want to rebuild (thank you Clippy!). It also tells us

> Rebuilding recreates your codespace. Currently cached images will be
> preserved, together with your code and any current changes. Your codespace
> will be rebuilt using your working directory's dev container.

Still fails. The princess is in another castle. The creation log shows the
following error:

```
2024-01-10 08:25:09.904Z: Compilation failed:2024-01-10 08:25:09.908Z:
2024-01-10 08:25:09.919Z: /workspaces/mastodon/node_modules/webpack-cli/bin/cli.js:93
				throw err;
				^
TypeError: Cannot read properties of undefined (reading 'compress')
...
    at Object.<anonymous> (/workspaces/mastodon/node_modules/webpack/bin/webpack.js:156:2)

Node.js v20.10.0

2024-01-10 08:25:10.012Z: postCreateCommand failed with exit code 1. Skipping any further user-provided commands.

```

Bisecting, I can zero into the following line causing the error:

```sh
# Precompile assets for test
RAILS_ENV=test ./bin/rails assets:precompile
```

Since we're not going to test, commenting it out.

---

Continuing with the steps in the mastodon README,

```sh
foreman start -f Procfile.dev
```

VS Code helpfully tells us

> Your application running on port 3000 is available.
>
> - See all forwarded ports.
> - Open in browser
> - Make public

Mastodon README says to choose open in browser. We get a new window saying
"connecting to the forwarded port...", and nice! the new window shows the
Mastodon UI.

Finally, the last step in the README is

> On the Ports tab, right click on the “stream” row and select Port visibility →
> Public.

But for now, the browser window it opened with the preview is enough for what we
want to do (see the impact of customizing the CSS), don't need to do this.

---

Styles seem to be in `app/javascript/styles/mastodon/`. Not sure what should be
pasted into the advanced prefs (custom CSS or custom SCSS?), so let us try to
login.

The admin account seems to be `admin@localhost`, but what's the password?

Trying `bin/tootctl`

```sh
$ bin/tootctl accounts create -h
Usage:
  tootctl accounts create USERNAME --email=EMAIL

Options:
  --email=EMAIL
  [--confirmed], [--no-confirmed]
  [--role=ROLE]
  [--reattach], [--no-reattach]
  [--force]
  [--approve], [--no-approve]

Description:
  Create a new user account with a given USERNAME and an e-mail address provided
  with --email.  With the --confirmed option, the confirmation e-mail will be
  skipped and the account will be active straight away.

  With the --role option, the role can be supplied.  With the --approve option,
  the account will be approved.
```

Refs:

* Create the admin user with tootctl #15850
  https://github.com/mastodon/mastodon/issues/15850

```sh
$ bin/tootctl accounts create admin1 --email=manav@mrmr.io --confirmed --role admin --approve
Cannot find user role with that name
$ bin/tootctl accounts create admin --email admin@localhost --confirmed --role admin
Cannot find user role with that name
```

Following this (Admin CLI doesn't work out of the box for 1-click Digital Ocean
installs](https://github.com/mastodon/mastodon/discussions/18137)), I think it
should be "Admin"

```sh
$ bin/tootctl accounts create admin --email admin@localhost --confirmed --role Admin
Failure/Error: account.username
    taken
Failure/Error: account.username
    reserved
```

Hmm. Trying `admin@localhost` again. [From
here](https://github.com/spinda/mastodon-documentation/blob/master/Running-Mastodon/Development-guide.md),
we see that the password is "mastodonadmin". Searching for that in code gives
us, in `db/seeds/04_admin.rb`:

```
User.where(email: "admin@#{domain}").first_or_initialize(email: "admin@#{domain}", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true).save!
```

So it should be `admin@#{domain}`. Replace localhost with the URL of the dev
container preview (without the https).

    admin@xxx-3000.app.github.dev

Worked!
